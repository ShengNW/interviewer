{% extends "base_user.html" %}

{% block title %}简历管理 - 夜莺面试官{% endblock %}

{% block extra_css %}
<style>
/* 树状结构样式 */
.resume-tree {
    padding-left: 0;
}

.resume-tree-item {
    position: relative;
    margin-bottom: 1rem;
}

.resume-tree-item .children {
    padding-left: 2.5rem;
    margin-top: 1rem;
    border-left: 2px dashed rgba(102, 126, 234, 0.3);
    margin-left: 1.25rem;
}

.resume-tree-item .children .resume-tree-item {
    position: relative;
}

.resume-tree-item .children .resume-tree-item::before {
    content: '';
    position: absolute;
    left: -2.5rem;
    top: 1.5rem;
    width: 2rem;
    height: 2px;
    background: rgba(102, 126, 234, 0.3);
}

/* 简历卡片样式 */
.resume-node {
    background: white;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    padding: 1rem 1.25rem;
    transition: all 0.3s ease;
}

.resume-node:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

.resume-node.status-draft {
    border-left: 4px solid #f59e0b;
}

.resume-node.status-published {
    border-left: 4px solid #10b981;
}

/* 状态徽章 */
.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-badge.draft {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
}

.status-badge.published {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
}

/* 深度指示器 */
.depth-indicator {
    font-size: 0.7rem;
    color: #9ca3af;
    background: #f3f4f6;
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
}

/* 操作按钮 */
.action-btn {
    padding: 0.35rem 0.75rem;
    border-radius: 8px;
    border: none;
    font-size: 0.8rem;
    transition: all 0.2s ease;
}

.action-btn:hover {
    transform: scale(1.05);
}

.action-btn.btn-fork {
    background: rgba(102, 126, 234, 0.1);
    color: var(--accent-blue);
}

.action-btn.btn-publish {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
}

.action-btn.btn-unpublish {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
}

.action-btn.btn-preview {
    background: rgba(168, 85, 247, 0.1);
    color: var(--accent-purple);
}

.action-btn.btn-delete {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

/* 创建简历卡片 */
.create-resume-card {
    border: 2px dashed rgba(102, 126, 234, 0.3);
    background: rgba(102, 126, 234, 0.02);
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.create-resume-card:hover {
    border-color: var(--accent-blue);
    background: rgba(102, 126, 234, 0.05);
    transform: translateY(-2px);
}

/* 空状态 */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #9ca3af;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    color: #d1d5db;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- 页面标题 -->
    <div class="row mb-4" style="margin-top: 40px;">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-1" style="font-size: 2rem;">
                    <i class="fas fa-file-alt me-3" style="color: var(--accent-blue);"></i>
                    简历管理
                </h2>
                <p class="text-muted mb-0">树状版本管理，轻松维护多个简历版本</p>
            </div>
            <button class="btn btn-primary" onclick="showCreateModal()" style="border-radius: 10px; padding: 0.6rem 1.5rem;">
                <i class="fas fa-plus me-2"></i>创建简历
            </button>
        </div>
    </div>

    <!-- 统计面板 -->
    <div class="row g-3 mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="card text-center" style="padding: 1rem;">
                <div class="d-flex align-items-center justify-content-center">
                    <div style="width: 40px; height: 40px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                        <i class="fas fa-file-alt" style="color: var(--accent-blue);"></i>
                    </div>
                    <div class="text-start">
                        <h5 class="mb-0 fw-bold" style="color: var(--accent-blue);" id="totalResumes">0</h5>
                        <small class="text-muted">简历总数</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card text-center" style="padding: 1rem;">
                <div class="d-flex align-items-center justify-content-center">
                    <div style="width: 40px; height: 40px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                        <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    </div>
                    <div class="text-start">
                        <h5 class="mb-0 fw-bold" style="color: var(--accent-green);" id="publishedResumes">0</h5>
                        <small class="text-muted">已发布</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card text-center" style="padding: 1rem;">
                <div class="d-flex align-items-center justify-content-center">
                    <div style="width: 40px; height: 40px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                        <i class="fas fa-edit" style="color: #f59e0b;"></i>
                    </div>
                    <div class="text-start">
                        <h5 class="mb-0 fw-bold" style="color: #f59e0b;" id="draftResumes">0</h5>
                        <small class="text-muted">编辑中</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card text-center" style="padding: 1rem;">
                <div class="d-flex align-items-center justify-content-center">
                    <div style="width: 40px; height: 40px; background: rgba(168, 85, 247, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                        <i class="fas fa-link" style="color: var(--accent-purple);"></i>
                    </div>
                    <div class="text-start">
                        <h5 class="mb-0 fw-bold" style="color: var(--accent-purple);" id="linkedRooms">0</h5>
                        <small class="text-muted">关联面试间</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 简历树列表 -->
    <div class="row">
        <div class="col-12">
            <div id="resumeTreesContainer">
                <!-- 由 JavaScript 动态生成 -->
            </div>
        </div>
    </div>
</div>

<!-- 创建简历模态框 -->
<div class="modal fade" id="createResumeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2" style="color: var(--accent-blue);"></i>
                    创建新简历
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-3">
                <form id="createResumeForm">
                    <div class="mb-0">
                        <label class="form-label mb-2">
                            <i class="fas fa-file-signature me-1"></i>
                            简历名称
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newResumeName" placeholder="例如：Java开发" required autofocus>
                            <span class="input-group-text" id="yearSuffix"></span>
                        </div>
                        <small class="text-muted">系统自动添加年份后缀</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary btn-sm" id="confirmCreateBtn">
                    <i class="fas fa-check me-1"></i>创建
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2" style="color: #ef4444;"></i>
                    确认删除
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmText">确定要删除这份简历吗？</p>
                <div class="alert alert-warning" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3);">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <small>删除将同时删除所有子版本，此操作不可恢复！</small>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-1"></i>确认删除
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 预览加载模态框 -->
<div class="modal fade" id="previewLoadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                <h6 class="mb-2">正在生成 PDF 预览...</h6>
                <small class="text-muted">这可能需要几秒钟</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 模态框实例
    const createModal = new bootstrap.Modal(document.getElementById('createResumeModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    const previewLoadingModal = new bootstrap.Modal(document.getElementById('previewLoadingModal'));

    let resumeToDelete = null;

    // 加载简历树
    loadResumeTrees();

    // 创建简历
    const currentYear = new Date().getFullYear();

    window.showCreateModal = function() {
        $('#createResumeForm')[0].reset();
        $('#yearSuffix').text('_' + currentYear);
        createModal.show();
        // 延迟聚焦，等模态框动画完成
        setTimeout(() => $('#newResumeName').focus(), 300);
    };

    // 回车键提交
    $('#newResumeName').on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $('#confirmCreateBtn').click();
        }
    });

    $('#confirmCreateBtn').on('click', function() {
        const baseName = $('#newResumeName').val().trim();
        if (!baseName) {
            alert('请输入简历名称');
            return;
        }

        // 自动添加年份后缀
        const name = baseName + '_' + currentYear;

        const data = {
            name: name,
            target_company: null,
            target_position: null
        };

        $.ajax({
            url: '/api/resumes',
            method: 'POST',
            contentType: 'application/json',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') },
            data: JSON.stringify(data),
            success: function(response) {
                if (response.code === 200) {
                    createModal.hide();
                    loadResumeTrees();
                    showToast('success', '简历创建成功');
                } else {
                    alert('创建失败：' + (response.message || '未知错误'));
                }
            },
            error: function(xhr) {
                alert('创建失败：' + (xhr.responseJSON?.message || '网络错误'));
            }
        });
    });

    // 加载简历树
    function loadResumeTrees() {
        $.ajax({
            url: '/api/resumes/trees',
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') },
            success: function(response) {
                if (response.code === 200) {
                    renderResumeTrees(response.data.trees);
                    updateStats(response.data.stats);
                }
            },
            error: function(xhr) {
                console.error('Failed to load resume trees:', xhr);
            }
        });
    }

    // 渲染简历树
    function renderResumeTrees(trees) {
        const container = $('#resumeTreesContainer');
        container.empty();

        if (!trees || trees.length === 0) {
            container.html(`
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <h5>还没有简历</h5>
                    <p class="mb-3">点击上方按钮创建你的第一份简历</p>
                    <button class="btn btn-primary" onclick="showCreateModal()">
                        <i class="fas fa-plus me-2"></i>创建简历
                    </button>
                </div>
            `);
            return;
        }

        trees.forEach(function(tree) {
            container.append(renderTreeNode(tree, 0));
        });
    }

    // 渲染树节点（递归）
    function renderTreeNode(node, depth) {
        const statusClass = node.status === 'published' ? 'status-published' : 'status-draft';
        const statusText = node.status === 'published' ? '已发布' : '编辑中';
        const statusBadgeClass = node.status === 'published' ? 'published' : 'draft';

        const canFork = depth < 4; // 最大深度5，所以depth<4时可以fork
        const isRoot = depth === 0;

        let html = `
            <div class="resume-tree-item">
                <div class="resume-node ${statusClass}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="d-flex align-items-center flex-grow-1" style="cursor: pointer;" onclick="viewResume('${node.id}')">
                            <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0;">
                                <i class="fas fa-file-alt" style="color: white; font-size: 1.2rem;"></i>
                            </div>
                            <div>
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <h6 class="mb-0 fw-bold">${escapeHtml(node.name)}</h6>
                                    <span class="status-badge ${statusBadgeClass}">${statusText}</span>
                                    ${depth > 0 ? `<span class="depth-indicator">L${depth}</span>` : ''}
                                </div>
                                <div class="text-muted" style="font-size: 0.85rem;">
                                    ${node.target_company ? `<span class="me-3"><i class="fas fa-building me-1"></i>${escapeHtml(node.target_company)}</span>` : ''}
                                    ${node.target_position ? `<span><i class="fas fa-briefcase me-1"></i>${escapeHtml(node.target_position)}</span>` : ''}
                                    ${!node.target_company && !node.target_position ? `<span class="text-muted">创建于 ${formatDate(node.created_at)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 flex-shrink-0">
                            <button class="action-btn btn-preview" onclick="previewResume('${node.id}')" title="预览PDF">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${canFork ? `
                            <button class="action-btn btn-fork" onclick="forkResume('${node.id}')" title="创建子版本">
                                <i class="fas fa-code-branch"></i>
                            </button>
                            ` : ''}
                            ${node.status === 'draft' ? `
                            <button class="action-btn btn-publish" onclick="publishResume('${node.id}')" title="发布">
                                <i class="fas fa-upload"></i>
                            </button>
                            ` : `
                            <button class="action-btn btn-unpublish" onclick="unpublishResume('${node.id}')" title="取消发布">
                                <i class="fas fa-undo"></i>
                            </button>
                            `}
                            <button class="action-btn btn-delete" onclick="deleteResume('${node.id}', '${escapeHtml(node.name)}', ${(node.children || []).length})" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
        `;

        // 递归渲染子节点
        if (node.children && node.children.length > 0) {
            html += '<div class="children">';
            node.children.forEach(function(child) {
                html += renderTreeNode(child, depth + 1);
            });
            html += '</div>';
        }

        html += '</div>';
        return html;
    }

    // 更新统计信息
    function updateStats(stats) {
        $('#totalResumes').text(stats.total_resumes || 0);
        $('#publishedResumes').text(stats.published || 0);
        $('#draftResumes').text(stats.draft || 0);
        $('#linkedRooms').text(stats.linked_rooms || 0);
    }

    // 查看简历详情
    window.viewResume = function(resumeId) {
        window.location.href = `/resumes/${resumeId}`;
    };

    // Fork 简历
    window.forkResume = function(resumeId) {
        if (!confirm('确定要基于此版本创建子版本吗？')) {
            return;
        }

        $.ajax({
            url: `/api/resumes/${resumeId}/fork`,
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') },
            success: function(response) {
                if (response.code === 200) {
                    loadResumeTrees();
                    showToast('success', '子版本创建成功');
                } else {
                    alert('创建失败：' + (response.message || '未知错误'));
                }
            },
            error: function(xhr) {
                alert('创建失败：' + (xhr.responseJSON?.message || '网络错误'));
            }
        });
    };

    // 发布简历
    window.publishResume = function(resumeId) {
        $.ajax({
            url: `/api/resumes/${resumeId}/publish`,
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') },
            success: function(response) {
                if (response.code === 200) {
                    loadResumeTrees();
                    showToast('success', '简历已发布');
                } else {
                    alert('发布失败：' + (response.message || '未知错误'));
                }
            },
            error: function(xhr) {
                alert('发布失败：' + (xhr.responseJSON?.message || '网络错误'));
            }
        });
    };

    // 取消发布
    window.unpublishResume = function(resumeId) {
        $.ajax({
            url: `/api/resumes/${resumeId}/unpublish`,
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') },
            success: function(response) {
                if (response.code === 200) {
                    loadResumeTrees();
                    showToast('success', '已取消发布');
                } else {
                    alert('操作失败：' + (response.message || '未知错误'));
                }
            },
            error: function(xhr) {
                alert('操作失败：' + (xhr.responseJSON?.message || '网络错误'));
            }
        });
    };

    // 预览 PDF
    window.previewResume = function(resumeId) {
        previewLoadingModal.show();

        $.ajax({
            url: `/api/resumes/${resumeId}/preview`,
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') },
            success: function(response) {
                previewLoadingModal.hide();
                if (response.code === 200 && response.data.preview_url) {
                    window.open(response.data.preview_url, '_blank');
                } else {
                    alert('预览失败：' + (response.message || '未知错误'));
                }
            },
            error: function(xhr) {
                previewLoadingModal.hide();
                alert('预览失败：' + (xhr.responseJSON?.message || '网络错误'));
            }
        });
    };

    // 删除简历
    window.deleteResume = function(resumeId, resumeName, childrenCount) {
        resumeToDelete = resumeId;
        let message = `确定要删除简历"${resumeName}"吗？`;
        if (childrenCount > 0) {
            message += `<br><br><strong>该简历有 ${childrenCount} 个子版本，将一并删除！</strong>`;
        }
        $('#deleteConfirmText').html(message);
        deleteModal.show();
    };

    $('#confirmDeleteBtn').on('click', function() {
        if (!resumeToDelete) return;

        deleteModal.hide();

        $.ajax({
            url: `/api/resumes/${resumeToDelete}`,
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') },
            success: function(response) {
                if (response.code === 200) {
                    loadResumeTrees();
                    showToast('success', response.message || '删除成功');
                    resumeToDelete = null;
                } else {
                    alert('删除失败：' + (response.message || '未知错误'));
                }
            },
            error: function(xhr) {
                alert('删除失败：' + (xhr.responseJSON?.message || '网络错误'));
            }
        });
    });

    // 辅助函数
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('zh-CN');
    }
});
</script>
{% endblock %}
