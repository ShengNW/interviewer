{% extends "base_user.html" %}

{% block title %}简历 - 夜莺面试官{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- 页面标题 -->
    <div class="row mb-4" style="margin-top: 40px;">
        <div class="col-12">
            <h2 class="fw-bold mb-1" style="font-size: 2rem;">
                <i class="fas fa-file-alt me-3" style="color: var(--accent-blue);"></i>
                简历管理
            </h2>
            <p class="text-muted mb-0">管理你的所有简历文档</p>
        </div>
    </div>

    <!-- 简历列表 -->
    <div class="row g-4 mb-5" id="resumesList">
        <!-- 上传新简历卡片 -->
        <div class="col-lg-4 col-md-6">
            <div class="card h-100 upload-resume-card" style="cursor: pointer; border: 2px dashed rgba(102, 126, 234, 0.3); background: rgba(102, 126, 234, 0.02); transition: all 0.3s ease;" onclick="document.getElementById('resumeFileInput').click()">
                <div class="card-body d-flex flex-column align-items-center justify-content-center text-center">
                    <div style="width: 80px; height: 80px; background: rgba(102, 126, 234, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; transition: all 0.3s ease;">
                        <i class="fas fa-upload" style="font-size: 2.5rem; color: var(--accent-blue);"></i>
                    </div>
                    <h5 class="fw-bold mb-2" style="color: var(--accent-blue);">上传新简历</h5>
                    <p class="text-muted mb-0" style="font-size: 0.9rem;">支持 PDF 格式</p>
                </div>
            </div>
        </div>

        <!-- 简历卡片将由JavaScript动态生成 -->
    </div>

    <!-- 统计面板 -->
    <div class="row g-4" style="margin-top: 3rem;">
        <div class="col-12 mb-3">
            <h5 class="fw-bold" style="color: #4a5568;">
                <i class="fas fa-chart-bar me-2"></i>简历统计
            </h5>
        </div>
        <div class="col-md-4 col-sm-6">
            <div class="card text-center" style="padding: 1.5rem 1rem;">
                <div style="width: 50px; height: 50px; margin: 0 auto 0.75rem; background: rgba(102, 126, 234, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-file-alt" style="font-size: 1.5rem; color: var(--accent-blue);"></i>
                </div>
                <h4 class="fw-bold mb-1" style="color: var(--accent-blue);" id="totalResumes">0</h4>
                <p class="mb-0 text-muted" style="font-size: 0.9rem;">简历总数</p>
            </div>
        </div>
        <div class="col-md-4 col-sm-6">
            <div class="card text-center" style="padding: 1.5rem 1rem;">
                <div style="width: 50px; height: 50px; margin: 0 auto 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check-circle" style="font-size: 1.5rem; color: var(--accent-green);"></i>
                </div>
                <h4 class="fw-bold mb-1" style="color: var(--accent-green);" id="totalResumes2">0</h4>
                <p class="mb-0 text-muted" style="font-size: 0.9rem;">已分析</p>
            </div>
        </div>
        <div class="col-md-4 col-sm-6">
            <div class="card text-center" style="padding: 1.5rem 1rem;">
                <div style="width: 50px; height: 50px; margin: 0 auto 0.75rem; background: rgba(168, 85, 247, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-link" style="font-size: 1.5rem; color: var(--accent-purple);"></i>
                </div>
                <h4 class="fw-bold mb-1" style="color: var(--accent-purple);" id="linkedRooms">0</h4>
                <p class="mb-0 text-muted" style="font-size: 0.9rem;">关联面试间</p>
            </div>
        </div>
    </div>
</div>

<!-- 隐藏的文件上传input -->
<input type="file" id="resumeFileInput" accept=".pdf" style="display: none;">

<!-- 上传简历模态框 -->
<div class="modal fade" id="uploadResumeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2" style="color: var(--accent-blue);"></i>
                    上传简历
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" id="closeModalBtn"></button>
            </div>
            <div class="modal-body">
                <form id="uploadResumeForm">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-file-signature me-1"></i>
                            简历名称 <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="resumeName" placeholder="例如：前端开发_张三" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-file-pdf me-1"></i>
                            已选择文件
                        </label>
                        <p class="text-muted mb-0" id="selectedFileName">
                            <i class="fas fa-check-circle text-success me-1"></i>
                            <span>无</span>
                        </p>
                    </div>
                    <div class="alert alert-info mb-0" style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.2); border-radius: 8px;">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>上传后将自动进行 PDF 解析和 OCR 识别，可能需要 30-60 秒，请耐心等待</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelUploadBtn">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-primary" id="confirmUploadBtn">
                    <i class="fas fa-cloud-upload-alt me-2"></i>开始上传
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 上传进度模态框 -->
<div class="modal fade" id="uploadProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="mb-4">
                    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <h5 class="fw-bold mb-3" id="uploadStatusTitle">正在上传简历...</h5>
                <p class="text-muted mb-4" id="uploadStatusText">正在上传文件到服务器</p>

                <!-- 进度步骤 -->
                <div class="progress-steps text-start" style="max-width: 400px; margin: 0 auto;">
                    <div class="step mb-3 pb-3" style="border-bottom: 1px solid #e2e8f0;" id="step-upload">
                        <div class="d-flex align-items-center">
                            <div class="spinner-grow spinner-grow-sm me-3 text-primary"></div>
                            <span>上传文件</span>
                        </div>
                    </div>
                    <div class="step mb-3 pb-3" style="border-bottom: 1px solid #e2e8f0; opacity: 0.5;" id="step-parse">
                        <div class="d-flex align-items-center">
                            <div class="spinner-grow spinner-grow-sm me-3 text-primary"></div>
                            <span>解析 PDF 文档</span>
                        </div>
                    </div>
                    <div class="step" style="opacity: 0.5;" id="step-ocr">
                        <div class="d-flex align-items-center">
                            <div class="spinner-grow spinner-grow-sm me-3 text-primary"></div>
                            <span>OCR 识别内容</span>
                        </div>
                    </div>
                </div>

                <p class="text-muted mt-4 mb-0" style="font-size: 0.875rem;">
                    <i class="fas fa-clock me-1"></i>
                    预计需要 30-60 秒，请勿关闭页面
                </p>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2" style="color: #ef4444;"></i>
                    确认删除
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0" id="deleteConfirmText">确定要删除这份简历吗？此操作不可恢复。</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-1"></i>确认删除
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 重命名模态框 -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2" style="color: var(--accent-blue);"></i>
                    重命名简历
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="renameForm">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-file-signature me-1"></i>
                            新名称 <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="newResumeName" placeholder="请输入新的简历名称" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-primary" id="confirmRenameBtn">
                    <i class="fas fa-check me-1"></i>确认
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* 确保所有简历卡片高度一致 */
.upload-resume-card,
.resume-card {
    min-height: 280px;
}

/* 简历卡片样式和左侧装饰线 */
.resume-card {
    border-top: 1px solid var(--border-color);
    border-right: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    border-left: 4px solid var(--accent-green);
    border-radius: 12px;
}

.upload-resume-card:hover {
    border-color: var(--accent-blue) !important;
    background: rgba(102, 126, 234, 0.05) !important;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
}

.upload-resume-card:hover .fa-upload {
    transform: scale(1.1);
}

.resume-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
}

.modal-dialog {
    margin-top: 100px !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let selectedFile = null;
    let resumeToDelete = null; // 存储要删除的简历ID
    let resumeToRename = null; // 存储要重命名的简历ID
    const uploadModal = new bootstrap.Modal(document.getElementById('uploadResumeModal'));
    const progressModal = new bootstrap.Modal(document.getElementById('uploadProgressModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    const renameModal = new bootstrap.Modal(document.getElementById('renameModal'));

    // 加载简历列表
    loadResumes();

    // 文件选择
    $('#resumeFileInput').on('change', function(e) {
        const file = e.target.files[0];
        console.log('File selected:', file);
        if (file) {
            // 验证文件类型
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showToast('warning', '只支持 PDF 格式的简历文件');
                this.value = '';
                return;
            }

            // 验证文件大小（限制10MB）
            if (file.size > 10 * 1024 * 1024) {
                showToast('warning', '文件大小不能超过 10MB');
                this.value = '';
                return;
            }

            selectedFile = file;
            $('#selectedFileName span').text(file.name);
            $('#resumeName').val(file.name.replace('.pdf', ''));

            // 显示上传对话框
            console.log('Showing upload modal...');
            uploadModal.show();
        }
        // 重置input，允许重新选择同一文件
        this.value = '';
    });

    // 确认上传
    $('#confirmUploadBtn').on('click', function() {
        if (!selectedFile) {
            alert('请选择文件');
            return;
        }

        const name = $('#resumeName').val().trim();
        if (!name) {
            alert('请输入简历名称');
            return;
        }

        const formData = new FormData();
        formData.append('resume', selectedFile);
        formData.append('name', name);

        uploadResume(formData);
    });

    // 上传简历
    function uploadResume(formData) {
        // 隐藏上传对话框
        uploadModal.hide();

        // 显示进度对话框
        progressModal.show();

        // 重置进度步骤
        resetProgressSteps();

        // 模拟进度更新（因为后端是同步的，我们模拟进度显示）
        let progressTimer = null;
        let currentStep = 0;

        progressTimer = setInterval(function() {
            currentStep++;
            if (currentStep === 1) {
                updateProgress('step-parse', '解析 PDF 文档中...');
            } else if (currentStep === 2) {
                updateProgress('step-ocr', 'OCR 识别内容中...');
            }
        }, 8000);

        $.ajax({
            url: '/api/resumes/upload',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
            },
            success: function(response) {
                clearInterval(progressTimer);

                if (response.code === 200) {
                    // 显示成功状态
                    showSuccess();

                    setTimeout(function() {
                        progressModal.hide();
                        loadResumes();
                        // 重置表单和文件
                        $('#uploadResumeForm')[0].reset();
                        $('#selectedFileName span').text('无');
                        selectedFile = null;
                    }, 2000);
                } else {
                    clearInterval(progressTimer);
                    progressModal.hide();
                    showToast('error', '上传失败：' + (response.message || '未知错误'));
                }
            },
            error: function(xhr) {
                clearInterval(progressTimer);
                progressModal.hide();

                const response = xhr.responseJSON;
                let errorMsg = '网络错误';

                if (response && response.message) {
                    errorMsg = response.message;
                }

                showToast('error', '上传失败：' + errorMsg);
                console.error('Upload error:', xhr);
            }
        });
    }

    // 重置进度步骤
    function resetProgressSteps() {
        $('#step-upload').css('opacity', '1').find('.spinner-grow').show();
        $('#step-parse').css('opacity', '0.5').find('.spinner-grow').show();
        $('#step-ocr').css('opacity', '0.5').find('.spinner-grow').show();

        $('#uploadStatusTitle').text('正在上传简历...');
        $('#uploadStatusText').text('正在上传文件到服务器');
    }

    // 更新进度
    function updateProgress(stepId, statusText) {
        // 完成上一步
        const prevSteps = {
            'step-parse': 'step-upload',
            'step-ocr': 'step-parse'
        };

        if (prevSteps[stepId]) {
            const prevStep = $('#' + prevSteps[stepId]);
            prevStep.find('.spinner-grow').replaceWith('<i class="fas fa-check-circle text-success me-3"></i>');
        }

        // 激活当前步骤
        $('#' + stepId).css('opacity', '1');
        $('#uploadStatusText').text(statusText);
    }

    // 显示成功状态
    function showSuccess() {
        $('#step-ocr').find('.spinner-grow').replaceWith('<i class="fas fa-check-circle text-success me-3"></i>');
        $('#uploadStatusTitle').html('<i class="fas fa-check-circle text-success me-2"></i>上传成功！');
        $('#uploadStatusText').text('简历已成功上传并识别完成');

        // 所有步骤显示完成
        $('.step').css('opacity', '1');
        $('.step .spinner-grow').replaceWith('<i class="fas fa-check-circle text-success me-3"></i>');
    }

    // 加载简历列表
    function loadResumes() {
        $.ajax({
            url: '/api/resumes',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
            },
            success: function(response) {
                if (response.code === 200) {
                    renderResumes(response.data.resumes);
                    updateStats(response.data.stats);
                }
            },
            error: function(xhr) {
                console.error('Failed to load resumes:', xhr);
            }
        });
    }

    // 渲染简历列表
    function renderResumes(resumes) {
        const container = $('#resumesList');
        const uploadCard = container.find('.upload-resume-card').parent();

        // 清空现有卡片（保留上传卡片）
        container.children().not(uploadCard).remove();

        resumes.forEach(function(resume) {
            const card = createResumeCard(resume);
            container.append(card);
        });
    }

    // 创建简历卡片
    function createResumeCard(resume) {
        const createdDate = new Date(resume.created_at).toLocaleDateString('zh-CN');

        return `
            <div class="col-lg-4 col-md-6">
                <div class="card h-100 resume-card" style="cursor: pointer; transition: all 0.3s ease;" onclick="if(!event.target.closest('button')) viewResume('${resume.id}')">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <i class="fas fa-file-pdf" style="color: white; font-size: 1.1rem;"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold">${resume.name}</h6>
                                <small class="text-muted">最后更新: ${createdDate}</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm" onclick="renameResume('${resume.id}', '${resume.name.replace(/'/g, "\\'")}'); event.stopPropagation();" style="background: rgba(102, 126, 234, 0.1); color: var(--accent-blue); border: none; padding: 0.375rem 0.75rem; border-radius: 8px;">
                                <i class="fas fa-edit me-1"></i>重命名
                            </button>
                            <button class="btn btn-sm" data-resume-id="${resume.id}" data-resume-name="${resume.name}" data-linked-rooms='${JSON.stringify(resume.linked_rooms || [])}' onclick="deleteResumeFromData(this); event.stopPropagation();" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; padding: 0.375rem 0.75rem; border-radius: 8px;">
                                <i class="fas fa-trash me-1"></i>删除
                            </button>
                        </div>
                    </div>

                    <div class="card-body">
                        ${resume.company || resume.position ? `
                        <div class="mb-2">
                            ${resume.company ? `<div><small class="text-muted"><i class="fas fa-building me-1"></i>${resume.company}</small></div>` : ''}
                            ${resume.position ? `<div><small class="text-muted"><i class="fas fa-briefcase me-1"></i>${resume.position}</small></div>` : ''}
                        </div>
                        ` : ''}
                        <div class="row text-center mt-3">
                            <div class="col-12">
                                <div style="padding: 0.5rem 0;">
                                    <h6 class="mb-1 fw-bold" style="color: var(--accent-purple);">${resume.linked_rooms_count || 0}</h6>
                                    <small class="text-muted">关联面试间</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // 更新统计信息
    function updateStats(stats) {
        $('#totalResumes').text(stats.total_resumes || 0);
        $('#totalResumes2').text(stats.total_resumes || 0);
        $('#linkedRooms').text(stats.linked_rooms || 0);
    }

    // 全局函数：查看简历
    window.viewResume = function(resumeId) {
        window.location.href = `/resumes/${resumeId}`;
    };

    // 全局函数：从按钮data属性读取数据并删除简历
    window.deleteResumeFromData = function(button) {
        const resumeId = $(button).attr('data-resume-id');
        const resumeName = $(button).attr('data-resume-name');
        const linkedRoomsStr = $(button).attr('data-linked-rooms');
        let linkedRooms = [];

        console.log('Delete button clicked:', {resumeId, resumeName, linkedRoomsStr});

        try {
            if (linkedRoomsStr && linkedRoomsStr !== 'null' && linkedRoomsStr !== '') {
                linkedRooms = JSON.parse(linkedRoomsStr);
            }
        } catch (e) {
            console.error('Failed to parse linked_rooms:', e, linkedRoomsStr);
        }

        deleteResume(resumeId, resumeName, linkedRooms);
    };

    // 全局函数：删除简历
    window.deleteResume = function(resumeId, resumeName, linkedRooms) {
        resumeToDelete = resumeId;
        let message = `确定要删除简历"${resumeName}"吗？`;
        if (linkedRooms && linkedRooms.length > 0) {
            message += `\n\n⚠️ 警告：该简历关联了 ${linkedRooms.length} 个面试间，删除简历将同时删除以下面试间：\n`;
            linkedRooms.forEach((room, index) => {
                message += `${index + 1}. ${room.id}: ${room.name}\n`;
            });
        }
        message += '\n此操作不可恢复。';
        $('#deleteConfirmText').html(message.replace(/\n/g, '<br>'));
        deleteModal.show();
    };

    // 确认删除按钮点击事件
    $('#confirmDeleteBtn').on('click', function() {
        if (!resumeToDelete) {
            return;
        }

        // 隐藏删除确认对话框
        deleteModal.hide();

        $.ajax({
            url: `/api/resumes/${resumeToDelete}`,
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
            },
            success: function(response) {
                if (response.code === 200) {
                    loadResumes();
                    resumeToDelete = null;
                } else {
                    alert('删除失败：' + (response.message || '未知错误'));
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                alert('删除失败：' + (response?.message || '网络错误'));
            }
        });
    });

    // 全局函数：重命名简历
    window.renameResume = function(resumeId, currentName) {
        resumeToRename = resumeId;
        $('#newResumeName').val(currentName);
        renameModal.show();
    };

    // 确认重命名按钮点击事件
    $('#confirmRenameBtn').on('click', function() {
        if (!resumeToRename) {
            return;
        }

        const newName = $('#newResumeName').val().trim();
        if (!newName) {
            alert('请输入新名称');
            return;
        }

        // 隐藏重命名对话框
        renameModal.hide();

        $.ajax({
            url: `/api/resumes/${resumeToRename}`,
            method: 'PUT',
            contentType: 'application/json',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
            },
            data: JSON.stringify({
                name: newName
            }),
            success: function(response) {
                if (response.code === 200) {
                    loadResumes();
                    resumeToRename = null;
                } else {
                    alert('重命名失败：' + (response.message || '未知错误'));
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                alert('重命名失败：' + (response?.message || '网络错误'));
            }
        });
    });
});
</script>
{% endblock %}
